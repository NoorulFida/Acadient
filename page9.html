<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TimeTrack | Timetable</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="styles/style9.css">

  <style>
    .present-subject {
      background-color: #4CAF50 !important;
      color: white;
    }

    .absent-subject {
      background-color: #f44336 !important;
      color: white;
    }
  </style>
</head>

<body>

<div class="header">
  <button class="arrow" onclick="location.href='page2.html'">â† Back</button>
</div>

<div class="container">
  <div class="page-header">
    <div class="logo-icon">ğŸ“…</div>
    <h2 id="title"></h2>
    <p class="subtitle" id="subtitle"></p>
  </div>

  <div class="timetable" id="timetable"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import {
    getFirestore,
    doc,
    getDoc,
    collection,
    getDocs
  } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCYMh-jojmpS07qjB4hbAE4VRwU0w9zkw0",
    authDomain: "login-form-74d6e.firebaseapp.com",
    projectId: "login-form-74d6e"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const timetableDiv = document.getElementById("timetable");
  const userData = JSON.parse(sessionStorage.getItem("data"));

  if (!userData) {
    timetableDiv.innerHTML = "No data found";
    throw new Error("Session data missing");
  }

  const { department, semester, day } = userData;

  title.innerText = department;
  subtitle.innerText = `Semester ${semester}`;

  async function loadTimetable() {
    const deptId = department.replace(/\s+/g, "_");
    const semId = `sem_${semester}`;

    const timetableRef = doc(db, "timetables", deptId, "semesters", semId);
    const timetableSnap = await getDoc(timetableRef);

    if (!timetableSnap.exists()) {
      timetableDiv.innerHTML = "Timetable not available";
      return;
    }

    const timetableData = timetableSnap.data();

    let days = [];
    if (day === "All") {
      days = ["monday", "tuesday", "wednesday", "thursday", "friday"];
    } else if (day === "Today") {
      const today = new Date().toLocaleDateString("en-US", { weekday: "long" });
      days = [today.toLowerCase()];
    } else {
      days = [day.toLowerCase()];
    }

    // âœ… Load teacher availability
    const availabilitySnap = await getDocs(collection(db, "teacherAvailability"));
    const availability = [];

    availabilitySnap.forEach(d => {
      availability.push({ email: d.id, ...d.data() });
    });

    renderTable(timetableData, days, availability);
  }

  function renderTable(timetableData, days, availability) {
    let html = `
      <div></div>
      <div class="timetable-cell header-cell">H1</div>
      <div class="timetable-cell header-cell">H2</div>
      <div class="timetable-cell header-cell">H3</div>
      <div class="timetable-cell header-cell">H4</div>
      <div class="timetable-cell header-cell">H5</div>
    `;

    days.forEach(d => {
      html += `<div class="timetable-cell day-cell">${d.toUpperCase()}</div>`;

      for (let i = 1; i <= 5; i++) {
        const subject = timetableData[d]?.[`P${i}`]?.subject || "-";
        let className = "";

        if (subject !== "-") {
          const teacher = availability.find(t => t.subject === subject);

          if (teacher && teacher[d] && teacher[d][i]) {
            if (teacher[d][i] === "present") className = "present-subject";
            if (teacher[d][i] === "absent") className = "absent-subject";
          }
        }

        html += `
          <div class="timetable-cell subject-cell ${className}">
            ${subject}
          </div>
        `;
      }
    });

    timetableDiv.innerHTML = html;
  }

  loadTimetable();
</script>

</body>
</html>
