<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TimeTrack | Timetable</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="styles/style9.css">
</head>

<body>

<div class="header">
  <button class="arrow" onclick="location.href='page2.html'">‚Üê Back</button>
</div>

<div class="container">
  <div class="page-header">
    <div class="logo-icon">üìÖ</div>
    <h2 id="title">Timetable</h2>
    <p class="subtitle" id="subtitle">View your weekly schedule</p>
  </div>

  <div class="timetable" id="timetable"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCYMh-jojmpS07qjB4hbAE4VRwU0w9zkw0",
    authDomain: "login-form-74d6e.firebaseapp.com",
    projectId: "login-form-74d6e",
    storageBucket: "login-form-74d6e.appspot.com",
    messagingSenderId: "305047532936",
    appId: "1:305047532936:web:8f7df19681a700f66df63d"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const userData = JSON.parse(sessionStorage.getItem("data"));
  const timetableDiv = document.getElementById("timetable");
  const title = document.getElementById("title");
  const subtitle = document.getElementById("subtitle");

  if (!userData) {
    timetableDiv.innerHTML = `<div class="no-data">No data found</div>`;
    throw new Error("No session data");
  }

  const { department, semester, day } = userData;

  title.innerText = department;
  subtitle.innerText = `Semester ${semester} Timetable`;

  async function loadTimetable() {
    const deptId = department.trim().replace(/\s+/g, "_");
    const semId = `sem_${semester}`;

    const ref = doc(db, "timetables", deptId, "semesters", semId);
    const snap = await getDoc(ref);

    if (!snap.exists()) {
      timetableDiv.innerHTML = `<div class="no-data">Timetable not available</div>`;
      return;
    }

    const data = snap.data();
    const daysArr = day === "All"
      ? ["monday", "tuesday", "wednesday", "thursday", "friday"]
      : [day.toLowerCase()];

    renderTable(data, daysArr);
  }

  function renderTable(data, daysArr) {
    let html = `<div></div>
      <div class="timetable-cell header-cell">Hour 1</div>
      <div class="timetable-cell header-cell">Hour 2</div>
      <div class="timetable-cell header-cell">Hour 3</div>
      <div class="timetable-cell header-cell">Hour 4</div>
      <div class="timetable-cell header-cell">Hour 5</div>`;

    daysArr.forEach(d => {
      html += `<div class="timetable-cell day-cell">${capitalize(d)}</div>`;
      for (let i = 1; i <= 5; i++) {
        html += `<div class="timetable-cell subject-cell">${data[d]?.[i]?.subject || "-"}
          ${data[d]?.[i]?.availability || "-"}
          </div>`;

      }
    });

    timetableDiv.innerHTML = html;
  }

  function capitalize(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
  }

  loadTimetable();
</script>

</body>
</html>
